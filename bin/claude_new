#!/usr/bin/env bash
set -euo pipefail

if [ $# -ne 1 ]; then
    tmux display-message "usage: claude_new <feature>"
    exit 1
fi

FEATURE="$1"

REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || {
    tmux display-message "claude_new: not in a git repo"
    exit 1
}

REPO_NAME=$(basename "$REPO_ROOT")
WORKTREE_BASE="$HOME/claude"
WORKTREE_PATH="$WORKTREE_BASE/${REPO_NAME}_${FEATURE}"
BRANCH_NAME="$FEATURE"
WINDOW_NAME="claude/${FEATURE}"

mkdir -p "$WORKTREE_BASE"

if [ ! -d "$WORKTREE_PATH" ]; then
    git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH"
fi

tmux neww -n "$WINDOW_NAME" bash -c "cd '$WORKTREE_PATH' && claude --dangerously-skip-permissions"
