#!/usr/bin/env bash
# Opens an existing worktree in ~/worktrees/${REPO_NAME}/${BRANCH_NAME}
# and a new tmux pane named worktrees/${BRANCH_NAME}

set -euo pipefail

REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || {
    tmux display-message "worktree_select: not in a git repo"
    exit 1
}

REPO_NAME=$(basename "$REPO_ROOT")
WORKTREE_BASE="$HOME/worktrees/$REPO_NAME"

if [ ! -d "$WORKTREE_BASE" ]; then
    tmux display-message "worktree_select: no worktrees found at $WORKTREE_BASE"
    exit 1
fi

WORKTREES=($(find "$WORKTREE_BASE" -mindepth 1 -maxdepth 1 -type d -exec basename {} \;))

if [ ${#WORKTREES[@]} -eq 0 ]; then
    tmux display-message "worktree_select: no worktrees found in $WORKTREE_BASE"
    exit 1
fi

SELECTED_BRANCH=$(printf "%s\n" "${WORKTREES[@]}" | fzf)

[[ -z "$SELECTED_BRANCH" ]] && exit 0

WORKTREE_PATH="$WORKTREE_BASE/$SELECTED_BRANCH"
WINDOW_NAME="worktree/$(echo "$SELECTED_BRANCH" | tr '/' '_')"

if tmux list-windows -F "#{window_name}" | grep -qx "$WINDOW_NAME"; then
    tmux select-window -t "$WINDOW_NAME"
else
    tmux neww -n "$WINDOW_NAME" bash -c "cd '$WORKTREE_PATH'; exec \$SHELL"
fi
